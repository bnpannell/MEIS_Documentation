# Methods
The following section details how to use the data and R code provided as well as an explanation of how the code works. 

## Reviewing the Parameters File
The first step in working with this code involves looking at the Parameters file. This file allows for alterations in the data analysis based on particular criteria that one may want to modify in their study, such as geography of interest, year, agencies of interest, and so forth. The default entries in the parameters file are based on this study of California. 

*Readme will eventually link to this section* 

## Making User Specific Data Files
The second step to focus on after modifying the parameters file is to ensure that user specific data files have been created in order to run this analysis. In this particular case, employment data (detailed in Section 3.1) and error check files were created in order to properly assign and allocate employment and spending data across California counties and congressional districts.

## Processing the Data
After modifying the parameter files with the appropriate criteria and creating user specific data, one can begin working through the code to process the data and prepare it for IMPLAN. Refer to the **deprecated_run_analysis_master.R** script to run through the data analysis process for this project.

### Clearing Environment, and Loading in Packages and Parameters
The first lines of code provide some housekeeping steps prior to running through the analysis. Line 6 allows the user to clear their global environment in RStudio, removing all previously defined or loaded packages, variables, values, etc. In running through the analysis wholesale, a good first step is to clear one's environment. Following this is lines 9-14, which load in the various RStudio library packages that are needed to perform this analysis. For more information on these packages, please refer to our References section ("ADD IN LINK TO REFERENCES AND/OR R PACKAGE DESCRIPTIONS"). The final housekeeping step involves line 17, which loads in the parameters file mentioned above. 

### Loading in Functions
Lines 20-23 compose the second step of the data analysis process: loading in functions that standardize and simplify working through the data. Line 20 loads in a function that is used to place additional filters on the obtained USAspending data and write the filtered data into CSV files. These additional filters are also outlined in the parameters file, but the actual filter function is not run until lines 26-30 (see step 3 for more details).

Line 21 loads in a function that concatenates the USAspending contract and grant data files into one dataframe in R, while also removing direct payments from that concatenation (as it is calculated separate from contracts and grants. more on this will be detailed below). The actual concatenate function is not run until lines 39 and 41 (see step 5 for more details). Line 22 loads in a function that splits out the concatenated USAspending dataframe by agency, taking out DOE data from the main dataframe. This is done because DOE's spending activity has been kept separate from the main data analysis of the project. The actual split function is not run until lines 44-47 (see step 6 for more details). Line 23 loads in a function that aggregates the USAspending and DOEspending dataframes by IMPLAN sector. This gets the contracts and grants spending data for two IMPLAN activity sheets complete: one for the main statewide analysis, and one for the DOE statewide analysis. The actual aggregate function is not run until lines 55-60 (see step 7 for more details).

### Obtaining the USAspending Data
Line 26 loads in a R script that performs a call to USAspending.gov's API that grabs the relevant contract, grant, and direct payment spending data that we need for our analysis and downloads it into two files (one for contracts, and one for grants/direct payments) at a specified file path location. In this case, the two CSV files obtained are downloaded into the data/temp folder. The parameters file is particularly important for this line of code, as the parameters file holds many of the filters that are used to sort what data is obtained from USAspending with this code.

### Filtering the USAspending Data
Lines 29-34 begin the third step of filtering down the USAspending data obtained from the API call. Lines 29 and 30 read in the downloaded contracts and grants/direct payments files (respectively) and assign them each to a variable. Lines 33 and 34 perform the filter_usaspending function (that was loaded in at line 20) on each of those variables. 

The filter_usaspending function has five elements that must be referenced: file_name, state, doe_filters, filters, and out_name. 

- The **file_name** element is a call to whichever data file we want to pass through to be filtered - in this case, the two USAspending CSVs that are defined in lines 29 and 30. 
- The **state** element is defined in our parameters, based on the state of interest for our study. In this case, that state is California. This element is added to ensure that the primary_place_of_performance_state is the same as the recipient_state (which was filtered in our obtain_usaspending function), thus ensuring that all data entries included in the analysis are in the state of interest for the study.
- The **doe_filters** element is defined in our parameters, based on **doe_offices**. This element is included to filter out DOE spending done in the state that is not national security-related. The basis for this filter element is from a list of DOE sub-agencies that were demarcated as national security-related.
- The **filters** element is defined in our parameters, based on **contract_columns** and **grant_columns**, respectively. This element is included to pare down the columns of data from the USAspending files to retain only the pertinent columns of data for our analysis.
- The **out_name** element is defined in our parameters, based on **c_out_name** and **g_out_name**, respectively. This element is included to give a naming convention for the files that get generated as a result of running the filter function.

After running the filter functions, two CSVs files should be generated in the data/temp folder, by the name defined from the **out_name** element.

### Error checking the USAspending Data
Lines 37-38 begin the fourth step of checking for errors in the filtered USAspending data and fixing them to have an IMPLAN code associated with each entry. The process for error checking and fixing the data are relatively the same for contracts and grants - the only major difference being the variable of interest in fixing the errors. For contracts, the focus is on NAICS codes, while the grants look at business types.

#### Error Checking Contracts
Line 37 loads in a R script file that goes through the filtered USAspending contracts file and remediates issues in certain contract entries. The first lines in this R script load two files into two dataframes: 1) the filtered USAspending contracts file (**contracts**); and 2) a NAICS to IMPLAN crosswalk that was [provided online on IMPLAN's website](https://support.implan.com/hc/en-us/articles/360034896614-546-Industries-Conversions-Bridges-Construction-2018-Data) (**naics_to_implan**). After reading in the NAICS to IMPLAN crosswalk, there are a couple of code fixes and removal of duplicate codes that our team determined to, in our best knowledge, be the most accurate way to relate those NAICS codes to an IMPLAN code. After this, the NAICS to IMPLAN crosswalk is merged into the contracts dataframe by NAICS code in order to get an IMPLAN code associated with each contract entry. 

However, this merge does not give all contract entries an IMPLAN code. This can be for a variety of reasons, including: 1) a contract entry from USAspending not having a NAICS code; and 2) an incorrect and/or outdated NAICS code that was not a part of IMPLAN's provided crosswalk. The lines of code following the merge work to fix the error contract entries. First, the contracts with no NAICS codes were hardcoded in the **contracts** dataframe to a specific IMPLAN code based on the contract recipient's name and the industry which they work in. Next, the contracts which had a mistyped or older NAICS code were pulled out to a new dataframe (**contracts_missing_implan**) and hardcoded to an IMPLAN code based on our team's best research into which IMPLAN code each entry would best fit into. This presents a degree of error when parsing out the contract spending, but also represents the best available workaround given time and information constraints. A new way of handling the error checks for contracts is detailed in [Section 9: What's Next](LINK TO SECTION 9 OF PROCESS GUIDE). 

The final steps of this contracts error check involve dropping out the contract entries which had no IMPLAN code from the original **contracts** dataframe. Then, the dataframe which fixed the contracts that were missing IMPLAN codes (**contracts_missing_implan**) is merged back into the original **contracts** dataframe. The **contracts** dataframe now has all contract entries "cleaned" with an IMPLAN code for each entry. Last, only the columns necessary for this analysis are selected, and then the cleaned **contracts** dataframe is written into a new CSV file.

#### Error Checking Grants/Direct Payments
Line 38 loads in a R script file that goes through the filtered USAspending grants and direct payments file and remediates issues in certain grants entries. First, the script loads in the filtered USAspending grants and direct payments file into a dataframe (**grants**). Next, we pull out the VA direct payments from the **grants** dataframe, and define it into its' own dataframe (**va_benefits**). This is done because VA direct payments does not a require an IMPLAN code and is thus calculated separate from contracts and grants from IMPLAN in the IMPLAN activity sheets. The **grants** dataframe filters out the direct payments based on the **assistance_code** column of the data, where entries that have an assistance code of 10 are the direct payment entries. 

After VA direct payments are separate from grants, the next step is to load a business type to IMPLAN crosswalk into a dataframe (**business_to_implan**). This file was self-created by the team as the best method for relating grants data to IMPLAN codes, given that USAspending grants data entries do not provide for NAICS codes. The business type to crosswalk is then merged with the **grants** dataframe in order to get an IMPLAN code associated with every grant entry.

However, this merge does not give all grant entries an IMPLAN code. In the case of the grants data, they may be missing a business type value, or their business type may be one that is not captured in the self-created crosswalk. Thus, the lines after the merge work to hardcode IMPLAN codes into the **grants** dataframe based on the grant recipient's name and the industry which they work in. After these hardcodes, a second dataframe (**grants_missing_implan**) is defined to capture if any other grant entries are missing an IMPLAN code. If a grant entry is still missing an IMPLAN code, it would need to be fixed in the **grants_missing_implan** dataframe and then merged back into the original **grants** dataframe. 

Now that the grants data has been "cleaned", the final steps in this script involve selecting only the necessary columns of data for the **va_benefits** and **grants** dataframes, and writing each one into their own respective CSV files.

### Manually Fixing Congressional District Errors
Lines 40 and 42 provide an important notice to only continue with the code once some manual fixes have been implemented in the three cleaned CSV files produced from the above error check codes. **This step is essential to ensuring no weird errors come out along the way.** The issue in the USAspending data for contracts, grants, and direct payments is the **recipient_congressional_district** column, where certain entries in all three CSV files have a district value of "NA" (contracts) or "90" (grants, and direct payments). There may be multiple reasons for this error, with the most plausible being that these data entries are in locations that span across multiple counties and/or congressional districts.

In order to properly remediate these issues, our team utilized the *DOD_County_Shares_R.xlsx* file in the raw data folder. Looking at this file, the "Districts" tab in that Excel sheet provides a breakdown of how much a county spans across one or multiple congressional district(s) based on land area from the California Redistricting Commission. We would then filter the contract, grant, or direct payment entries by county, and randomly assign a certain number of entries to a district based on their county. For example, if 20 contract entries that had a "NA" value in the district column were in Alameda County, we would assign 47% of those entries (~9) to CA-13, 42% (~8) to CA-15, and 12% (~3) to CA-17.

This method also inherently presents a degree of error with allocating spending across congressional districts. Even so, given time constraints, this workaround presented itself as the best solution at the time. Our team is working on a new way to address these manual fixes through code - for more details, refer to [Section 9: What's Next](LINK TO SECTION 9 OF PROCESS GUIDE).

### Concatenating the USAspending Data
Lines 45-46

### Splitting DOE from USAspending Data
Lines 49-52

### Aggregating the spending Data for Statewide Numbers
Lines 58-59 and 61-63 

### Compiling Employment Data
Lines ??-??

### Running For Loops to Generate IMPLAN Activity Sheets
Line ??

- Process data 
  - Clean contracts and grant data- 
  - Clean spending data
  - Error check contract spending data 
  
  Will need to go into detail about changes in the code between this year (2021) and subsequent years

  More detailed mention of how the error checking of the USASpending.gov contract data is needed
  A detailed walk through of how to manually check data and use the multiple NAICS to IMPLAN crosswalks to catch data
  Mention how IMPLAN automatically removes any codes having to do with construction so those have to be manually coded

  Some errors occur due to the transaction not being given a NAICS code, those need to be manually fixed

  Issues occur with NAICS codes that apply to multiple IMPLAN codes- give detailed explanation of how this was worked around and data was processed and added back to the main cleaned data. 

